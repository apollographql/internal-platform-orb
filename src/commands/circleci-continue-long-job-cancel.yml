description: for any job that is old, cancel it and warn the people. Must run the setup command on each new executor

parameters:
  org-repo-slug:
    type: string
    description: "github-username-or-org-name/repo-name"
  render-workflow-yml-file-path:
    type: string
    description: Use the generated information to render the mustache file at this path
  circleci-token-variable:
    description: the name of the environmental variable that contains the circleci token
    default: "CIRCLECI_TOKEN"
    type: string
  rendered-workflow-name:
    description: the name used for the rendered workflow
    default: "warn-workflow.yml"
    type: string
  rendered-workflow-params:
    description: parameters to pass in for the rendered workflow
    default: "{}"
    type: string

steps:
  - run:
      name: Cancel long jobs
      working_directory: /tmp/apollo_internal_platform_orb/src/scripts/circleci-job-canceller
      command: |
        python3 -m pip install -r requirements.txt
        python3 long_job_canceller.py $<< parameters.circleci-token-variable >> << parameters.org-repo-slug >> --just-do-it
  - run:
      name: Spawn workflow jobs for warnings
      working_directory: /tmp/apollo_internal_platform_orb/src/scripts/render-yaml-from-tsv
      command: |
        python3 -m pip install -r requirements.txt
        mkdir -p /tmp/circle/
        python3 render-yaml-from-tsv.py "<< parameters.render-workflow-yml-file-path >>" /tmp/notifications.tsv  > /tmp/circle/<< parameters.rendered-workflow-name >>
        echo << parameters.rendered-workflow-params >> > /tmp/circle/warn-workflow-params.json
  - run:
      name: Halt if no warning changes
      command: |
          if [ ! -s /tmp/circle/<< parameters.rendered-workflow-name >> ]
          then
             circleci-agent step halt
          fi
  - continuation/continue:
        configuration_path: /tmp/circle/<< parameters.rendered-workflow-name >>
        parameters: /tmp/circle/warn-workflow-params.json
  - store_artifacts:
        path: /tmp/circle/
