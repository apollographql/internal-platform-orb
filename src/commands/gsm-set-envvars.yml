description: Retrieve one or more secrets from Google Secret Manager (GSM) and set them as environment variables in the current executor. Expects the gcloud cli to be available and to have already authenticated to a GCP project that contains the requested secrets
parameters:
  envvar-secret-map:
    type: string
    description: A mapping of environment variable names to GSM Secret names in key=value format. Multiple can be specified command separated. For example this value could be "MY_ENVVAR1=GSMSecretOne,MY_ENVVAR_2=GSMSecretTwo"

steps:
  - run:
      name: Retrieve and write secret
      command: |
        echo "<< parameters.envvar-secret-map >>" | sed -n 1'p' | tr ',' '\n' | while read word; do
          IFS='=' read -r -a array \<<< $word
          VALUE=$(gcloud secrets versions access latest --secret=${array[1]} --project=${GCP_PROJECT_ID})
          echo "${array[0]}=\"${VALUE}\"" >> "$BASH_ENV"
        done
